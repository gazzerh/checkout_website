image:
    name: hashicorp/terraform:light
    entrypoint:
        - '/usr/bin/env'
        - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'

before_script:
    - rm -rf .terraform
    - terraform --version
    - mkdir -p ~/.aws
    - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
    - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
    - cd ./infra
    - terraform init

stages:
    - validate
    - plan

validate:
    stage: validate
    tags: 
    - terraform-aws
    script:
    - terraform validate

plan:
    stage: plan
    script:
        - terraform plan -out "planfile"
    dependencies:
        - validate
    artifacts:
        paths:
            - planfile